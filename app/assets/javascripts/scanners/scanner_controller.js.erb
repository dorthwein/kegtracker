// Scanner JS
/* Handle Codes
	1 = Delivery
	2 = Pickup
	3 = Add
	4 = Fill
	5 = Move	
*/
$( '#_scanners_barcode' ).live( 'pageshow',function(event){      
    var theme = settings.theme;
	$(".scanner.dropdown").jqxDropDownList({
		displayMember: "html", 
		valueMember: "value", 
		width: 200, 
		height: 25, 
		theme: theme, 
		animationType: 'none',
	});


	url = system.server + $('.ui-page-active').attr('data-url') + '.json'

	$.ajax({
		url: url,
		type: "POST",
		dataType : "JSON",		
	}).done(function( data ) {				
		$('#handle_code').jqxDropDownList({source: data['handle_codes_auto_mode_on']});
	    $("#handle_code").bind('select', function (event) {
		    var args = event.args;
		    if (args) {
		        // index represents the item's index.                
		        var index = args.index;
		        var item = args.item;
		        // get item's label and value.
		        var label = item.label;
		        var value = item.value;
		    	if(value == 4){
					$('#product_id').jqxDropDownList({disabled: false});		    		
		    	} else {
		    		$('#product_id').jqxDropDownList({disabled: true});		    		
		    	}
		    }                        	        
	    });
		$('#asset_type_id').jqxDropDownList({source: data['asset_types'], disabled: true});
		$('#location_network_id').jqxDropDownList({source: data['location_networks']});
		$('#product_id').jqxDropDownList({source: data['products'], disabled: true});
	
	    $('.flip_switch.scanner').jqxSwitchButton({ height: 20, width: 75, theme: 'fresh', checked: false });
	    $('#toggle_auto_mode').jqxSwitchButton({checked: true});
	    $('#toggle_auto_mode').val(1);
		$('#toggle_correction').val(0);

	    $("#location_network_id").bind('select', function (event) {
		    var args = event.args;
		    if (args) {
		        // index represents the item's index.                
		        var index = args.index;
		        var item = args.item;
		        // get item's label and value.
		        var label = item.label;
		        var value = item.value;
		    	$('#location_id').jqxDropDownList({source: data['locations_by_network'][value]});        
		    }                        	        
	    });

		$('#toggle_auto_mode').bind('checked', function (event) { 
			$('#handle_code').jqxDropDownList({source: data['handle_codes_auto_mode_on']});
			$('#toggle_auto_mode').val(1)
		}); 
		$('#toggle_auto_mode').bind('unchecked', function (event) { 
			$('#handle_code').jqxDropDownList({source: data['handle_codes_auto_mode_off']});			
			$('#toggle_auto_mode').val(0)
		}); 

		$('#toggle_asset_type').bind('checked', function (event) { 
			$('#asset_type_id').jqxDropDownList({disabled: false});
			$('#toggle_asset_type').val(1)
		
		}); 
		$('#toggle_asset_type').bind('unchecked', function (event) { 
			$('#asset_type_id').jqxDropDownList({disabled: true});
			$('#toggle_asset_type').val(0)
		}); 
		$('#toggle_correction').bind('checked', function (event) { 
			$('#toggle_correction').val(1)
		}); 
		$('#toggle_correction').bind('unchecked', function (event) { 
			$('#toggle_correction').val(0)
		}); 
		$('#simple_container').jqxValidator({
		 	rules: [
		 		// Email Rules
		        { input: '#scan_input', message: 'Scan Required', action: 'keyup, blur', rule: 'required' },
		        // First/Last Name

		        { input: '#location_id', message: 'Location Required!', action: 'keyup, blur',rule: function(input, commit){		        		            
			            if (  $("#location_id").jqxDropDownList('getSelectedItem') != null) {
			                return true;		                
			            }
			           	return false;		           
		        	}
		        },
		        { input: '#location_network_id', message: 'Network Required!', action: 'keyup, blur',rule: function(input, commit){
			            if (  $("#location_network_id").jqxDropDownList('getSelectedItem') != null) {
			                return true;		                
			            }
			           	return false;		           
		        	}
		        },

		        { input: '#handle_code', message: 'Action Required!', action: 'keyup, blur',rule: function(input, commit){
			            if (  $("#handle_code").jqxDropDownList('getSelectedItem') != null) {
			                return true;		                
			            }
			           	return false;		           
		        	}
		        },
		        { input: '#product_id', message: 'Product Required!', action: 'keyup, blur',rule: function(input, commit){
			            if (  $("#handle_code").jqxDropDownList('getSelectedItem') != null) {
			                if (  $("#handle_code").jqxDropDownList('getSelectedItem').value == 4 ) {
			                	if( $("#product_id").jqxDropDownList('getSelectedItem') != null){			                		
			                		return true;
			                	} else {
			                		return false;
								}
			            	} else {return true;}			           	
		        		}
		        	}
		        },	        
		        { input: '#asset_type_id', message: 'Asset Type Required!', action: 'keyup, blur',rule: function(input, commit) {			            			            
			            if($("#toggle_asset_type").val() == 1 ){
			            	
			                if (  $("#asset_type_id").jqxDropDownList('getSelectedItem') != null){
			                	return true;
			                } else { return false; }		                
						}
						return true;  
		        	}
		        }	        	        
			],
			theme: theme
		});

	})

	$("#scan_input").jqxInput({placeHolder: "Scan Barcode...", height: 25, minLength: 1, theme: theme });
    $("#docking").jqxDocking({theme: theme, mode: 'docked', width: '100%' });

    $('#docking').jqxDocking('pinWindow', 'slot_1');
    $('#docking').jqxDocking('pinWindow', 'slot_2');
    $('#docking').jqxDocking('pinWindow', 'slot_3');

    $('#docking').jqxDocking('pinWindow', 'slot_4');
    $('#docking').jqxDocking('pinWindow', 'slot_5');
    $('#docking').jqxDocking('pinWindow', 'slot_6');

    $('#docking').jqxDocking('setWindowProperty','slot_1', 'keyboardCloseKey', 'none' );
    $('#docking').jqxDocking('setWindowProperty','slot_2', 'keyboardCloseKey', 'none' );
    $('#docking').jqxDocking('setWindowProperty','slot_3', 'keyboardCloseKey', 'none' );
    $('#docking').jqxDocking('setWindowProperty','slot_4', 'keyboardCloseKey', 'none' );
    $('#docking').jqxDocking('setWindowProperty','slot_5', 'keyboardCloseKey', 'none' );
    $('#docking').jqxDocking('setWindowProperty','slot_6', 'keyboardCloseKey', 'none' );
	


	pgFunc = {};		// clear page function
	var	params = {};		// Default scan options
	params.scanner = {};	

	pgFunc = {
/*
		asset_type_toggle : function() {
			var asset_type_toggle = $('#asset_type_toggle').find(":selected").attr('value');
			if(asset_type_toggle == 'true'){
				$('#asset_type').selectmenu('enable')						
			} else {
				$('#asset_type').selectmenu('disable')									
			}
		},

		change_handle_code : function() {
			var hc = $('#handle_code').find(":selected").attr('data-code');
			$('#asset_type_toggle').val("false").slider('refresh');
			if( hc == 3){
				$('#asset_type').selectmenu('enable')
			} else {
				$('#asset_type').selectmenu('disable')			
			}
			
			if( hc == 4){
				$('#asset_type_toggle').slider('enable')
				$('#product').selectmenu('enable')

			} else {
				$('#product').selectmenu('disable')
			}	
			if( hc == 7){
				$('#product').selectmenu('disable')
				$('#location').selectmenu('disable')				
				$('#asset_type').selectmenu('disable')				
				$('#asset_type_toggle').slider('disable')								
			} else {
				$('#asset_type_toggle').slider('enable')
				$('#location').selectmenu('enable')
			}
		},
*/

		scanSubmit : function(obj){		
			var scan = {};
			scan.user = {};
			scan.processing = {};
			
			function IsJsonString(str) {
				try {
					if(typeof jQuery.parseJSON(obj)	== 'object'){
						return true;
					} else {
						return false;
					}
				} catch (e) {
					return false;
				}
				return true;
			}
			if( IsJsonString(obj) ){
				 var tag = jQuery.parseJSON(obj);
				 console.log('Valid JSON: ' + tag);         
			} else if(
				((obj.split("{").length - 1) > 0 && (obj.split("}").length - 1) == 0 ) ||
				((obj.split("}").length - 1) > 0 && (obj.split("{").length - 1) == 0 ) ||				
				((obj.split("[").length - 1) > 0 && (obj.split("]").length - 1) == 0 ) ||				
				((obj.split("]").length - 1) > 0 && (obj.split("[").length - 1) == 0 ) || 
				((obj.split("]").length - 1) >= 1 && (obj.split("[").length - 1) >= 1 ) || 				
				((obj.split("}").length - 1) >= 1 && (obj.split("{").length - 1) >= 1 ) 
			) {
				$('#scan_input').val("");							
				$('#scan_light').css('background', '#FF0000');
				$('#scan_light span').html('FAIL');
				
				<% beep = asset_path 'beep-3.mp3' %>
				$('#content-alert').html('<audio autoplay="autoplay"> <source src="<%= beep %>" type="audio/mp3" /> </audio>');
				
				$('#slot_1').html('');
				$('#slot_2').html('');
				$('#slot_3').html('');
				$('#slot_4').html('');
				
				return false
			} else {				
				console.log('scan not valid json: ' + obj);                     
				var tag = {};
				tag.N;
				tag.V = obj;
				tag.K = 0;
				tag.M = 3;			
			}
			if( $('#simple_container').jqxValidator('validate')	){
				scan.tag = tag;
				scan.user = {};
				var N = $('#simple_container').attr('userName');
				var P = 'PASS';
				scan.user.N = N;
				scan.user.P = P;

				scan.location = $('#location_id').jqxDropDownList('getSelectedItem').value;
				scan.processing.HC = $('#handle_code').jqxDropDownList('getSelectedItem').value;
				scan.processing.auto_mode = $('#toggle_auto_mode').val();
				scan.processing.correction = $('#toggle_correction').val();

				scan.version = "s1";

				if($('#handle_code').jqxDropDownList('getSelectedItem').value == 4){
					scan.processing.P = $('#product_id').jqxDropDownList('getSelectedItem').value;			
				}

				if($('#toggle_asset_type').value == 1){
					scan.processing.AT = $("#asset_type_id").jqxDropDownList('getSelectedItem').value;			
				}

				scan.processing.T = + new Date / 1000;
//				alert(JSON.stringify(scan));
				var url = system.server + '/scanners/barcode/scan.json';
				$('#scan_input').val("");				
				$.ajax({
					   url: url,	
					   type: "POST",
					   data: { scan : JSON.stringify(scan) },				   
					   dataType: "JSON",
					   success: function( data ){ 				   		
							// Update Recents table
							for (var i=0; i < data.length; i++){
								var tag = data[i];
								var d = new Date();							
	/*							$('#scanAlerts').dataTable().fnAddData( [
									d.toLocaleTimeString(),
									tag.Network, 
									tag.Value, 
									tag.Location, 
									tag.Brewery,
									tag.Product,
									tag.Fill,
									tag.Size, 
									tag.Action
								] );		
	*/											
								$('#slot_1').html(tag.Location);
								$('#slot_2').html(tag.Action);
								$('#slot_3').html(tag.Product);
								$('#slot_4').html(tag.Size);
								
								<% beep = asset_path 'beep-2.mp3' %>
								$('#content-alert').html('<audio autoplay="autoplay"> <source src="<%= beep %>" type="audio/mp3" /> </audio>');
								$('#scan_light').css('background', '#00FF00')
								$('#scan_light span').html('SUCCESS')
		
		
							};
					   },
					   error: function( data ){					
							$('#slot_1').html('');
							$('#slot_2').html('');
							$('#slot_3').html('');
							$('#slot_4').html('');
						
							$('#scan_input').val("");
							$('#scan_light').css('background', '#FF0000')
							$('#scan_light span').html('FAIL')

							<% beep = asset_path 'beep-3.mp3' %>
							$('#content-alert').html('<audio autoplay="autoplay"> <source src="<%= beep %>" type="audio/mp3" /> </audio>');
					   
							console.log('Connection Failed');
							console.log(JSON.stringify(data));
					   }
				}); 	
			} else {
				$('#scan_input').val("");
				$('#scan_light').css('background', '#FF0000')
				$('#scan_light span').html('FAIL')

				<% beep = asset_path 'beep-3.mp3' %>
				$('#content-alert').html('<audio autoplay="autoplay"> <source src="<%= beep %>" type="audio/mp3" /> </audio>');

			}
		}	
		
	};
//	pgFunc.change_handle_code();
	
	// *****************************
	// Key Listener & Click Lock
	// *****************************
	$(window).unbind('keydown');	// Unbinding incase previously bound to prevent multiple sends
	$(window).keydown(function(event) {				
		$('#scan_input').focus();
		console.log('scanned: '+event.keyCode);
		if(event.keyCode == '13'){
			event.preventDefault();		
			pgFunc.scanSubmit($('#scan_input').val());
		}
	});	
});
// UNBIND KEY LOCK ON HIDE
$( '#_scanners_barcode' ).bind( 'pagehide',function(event){      
	$(window).unbind('keydown');
	delete pgFunc;
	delete scanOptions;
});

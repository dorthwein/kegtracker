// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$( '#_reports_network_in_out_asset_report_advanced' ).live('pageshow', function(event){
	// prepare the data
	$.mobile.loading('show');
	var theme = settings.theme

	var source = {
		datatype : "json",
		type: 'GET',
		datafields: [
			{ name: 'date' },				
			{ name: 'location_network' },
			{ name: 'location_network_asset_type_id' },
			{ name: 'asset_type' },
			{ name: 'product' },
			{ name: 'product_entity' },			


			{ name: 'sku' },
			{ name: 'sku_id' },
			{ name: 'date_id' },

//			{ name: 'in_full_quantity' },
//			{ name: 'in_market_or_empty_quantity' },			
			{ name: 'in_total_quantity' },

//			{ name: 'out_full_quantity' },
//			{ name: 'out_market_or_empty_quantity' },		
			{ name: 'out_total_quantity' }
		],
		url: system.server + $('.ui-page-active').attr('data-url') + '.json'
	};

	var dataAdapter = new $.jqx.dataAdapter(source, {
		loadComplete: function (data) { },
		loadError: function (xhr, status, error) { }      
	});
	// Initialize Grid
	$("#jqxgrid").jqxGrid({		
		groupable: true,
		sortable: true,
		filterable: true,
        showfilterrow: true,		
		autoshowfiltericon: true,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: true,
		height: system.table_height,
		source: dataAdapter,
		columnsresize: true,
		altrows: true,	
		ready: function() {
			load_chart();
		},              
		columns: [
			{ text: 'Date', datafield: 'date', filtertype: 'date', cellsformat: 'd'  },																	
			{ text: 'Location Network', datafield: 'location_network', filtertype: 'checkedlist' },
			{ text: 'SKU', 			width:'250px', datafield: 'sku', filtertype: 'checkedlist'  },
			{ text: 'Product', 		width:'250px', datafield: 'product', filtertype: 'checkedlist'  },
			{ text: 'Brewery',		datafield: 'product_entity', filtertype: 'checkedlist'  },
			{ text: 'Asset Type', datafield: 'asset_type', filtertype: 'checkedlist' },		
//			{ text: 'In - Full', 			cellsalign: 'center',	width:'75px',	datafield: 'in_full_quantity' },			
//			{ text: 'In - Market/Empty', 	cellsalign: 'center',	width:'75px',	datafield: 'out_market_or_empty_quantity' },			
//			{ text: 'In - Empty', 			cellsalign: 'center',	width:'75px',	datafield: 'in_empty_quantity' },						
			{ text: 'In Bound',			cellsalign: 'center',	width:'75px',	datafield: 'in_total_quantity' },
//			{ text: 'Out - Full', 			cellsalign: 'center',	width:'75px',	datafield: 'out_full_quantity' },			
//			{ text: 'Out - Market/Empty', 	cellsalign: 'center',	width:'75px',	datafield: 'out_market_or_empty_quantity' },
//			{ text: 'Out - Empty', 			cellsalign: 'center',	width:'75px',	datafield: 'out_empty_quantity' },						
			{ text: 'Out Bound', 			cellsalign: 'center',	width:'75px',	datafield: 'out_total_quantity' }
		],
        groups: ['date','location_network']
	});


	
	$("#advancedView").jqxButton({ theme: theme });
	$("#simpleView").jqxButton({ theme: theme });

	// Style Buttons
	$("#excelExport").jqxButton({ theme: theme });
	$("#csvExport").jqxButton({ theme: theme });

	// Button Processing/Action
	
	// NEW BUTTON

	

	$("#excelExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'xls', 'jqxGrid');           
	});
	$("#csvExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'csv', 'jqxGrid');
	});
	$.mobile.loading('hide');				



	function load_chart(){								
		var rows = $('#jqxgrid').jqxGrid('getrows');			
//		alert(JSON.stringify(rows));
		data_set = {}
		chart_series = [];
		location_network_asset_type_ids = [];
		var unit_interval_max = 1;
		day_limit_counter = 0

		// General Data Set
		$.each(rows, function(key, row){	
//			alert(JSON.stringify(row));		    		
    		if(data_set[row['date_id']] == undefined){
    			data_set[row['date_id']] = {};
    			series = {dataField: row['date_id'], displayText: row['date']}
    			day_limit_counter = day_limit_counter + 1
    		}
    		if(data_set[row['date_id']][row['location_network_asset_type_id']] == undefined){
    			data_set[row['date_id']][row['location_network_asset_type_id']] = {};
				
				if(	$.inArray(row['location_network_asset_type_id'], location_network_asset_type_ids) == -1){	
					series = {dataField: row['location_network_asset_type_id'], displayText: row['asset_type'] + ' - ' + row['location_network']}
					location_network_asset_type_ids.push(row['location_network_asset_type_id']);
					chart_series.push(series);
				}
    		}
			data_set[row['date_id']][row['location_network_asset_type_id']]['displayText'] = 		row['asset_type'] + ' - ' + row['location_network'];
    		data_set[row['date_id']][row['location_network_asset_type_id']]['in_total'] = 			row['in_total_quantity'];
    		data_set[row['date_id']][row['location_network_asset_type_id']]['out_total'] = 			row['out_total_quantity'];    		

    		if((row['in_total_quantity'] + unit_interval_max) > unit_interval_max){
    			unit_interval_max = unit_interval_max + row['in_total_quantity']

    		} else if((row['out_total_quantity'] + unit_interval_max) > unit_interval_max){    			
				unit_interval_max = unit_interval_max + row['out_total_quantity']
    		}

		}); 
		
		unit_interval = Math.ceil(unit_interval_max / 5)


		// Full Quanitites
		in_total_data_set = [];
		out_total_data_set = [];
		
		// Date Record
		$.each(data_set, function(date_id, date_record){
			// Ske Record
			date = new Date(date_id * 1000).toLocaleDateString();
			var in_total_fact_record = { date: date };
			var out_total_fact_record = { date: date };
			
			
			$.each(date_record, function(asset_type_id, in_out_record){
				in_total_fact_record[asset_type_id] = in_out_record['in_total']				
				out_total_fact_record[asset_type_id] = in_out_record['out_total']				
			
			})
			in_total_data_set.push(in_total_fact_record);		
			out_total_data_set.push(out_total_fact_record);		
			
		});	
	
    // prepare jqxChart settings
   
	    var settings = {
	        title: " ",
	        description: " ",
	        enableAnimations: true,
	        showLegend: true,
            showBorderLine: false,                
            padding: { left: 5, top: 5, right: 5, bottom: 5 },
	        titlePadding: { left: 90, top: 0, right: 0, bottom: 10 },
	        showBorderLine: false,
	        source: {},
	        categoryAxis:
	            {
					dataField: 'date',											
					textRotationAngle: 90,
					tickMarksColor: '#888888',
	                axisSize: 'auto',
					alignEndPointsWithIntervals: true,				
	        		enableAnimations: true,						
					gridLinesColor: '#888888',

	            },
	        colorScheme: 'scheme01',
	        seriesGroups:
	            [
	                {
	                    type: 'stackedcolumn',
	                    valueAxis:
	                    {	          
 	                       	minValue: 0,
//    	                    maxValue: unit_interval_max,	                    	
//	                    	unitInterval: unit_interval,
	                    	formatSettings: { decimalPlaces:  0 },              
	                        description: '# Assets',
	                        showGridLines: false
	                    },
	                    series: chart_series
	                }	                
	            ]
	    };

	    $('#docking').jqxDocking({ theme: theme,  orientation: 'horizontal', width: '100%', mode: 'docked' });
	    $('#docking').jqxDocking('disableWindowResize', 'window1');
	    $('#docking').jqxDocking('disableWindowResize', 'window2');
		$('#docking').jqxDocking('pinWindow', 'window1');
		$('#docking').jqxDocking('pinWindow', 'window2');
		$('#docking').jqxDocking('hideAllCloseButtons');
	    
		$('#docking').jqxDocking('setWindowProperty','window1', 'keyboardCloseKey', 'none' );
		$('#docking').jqxDocking('setWindowProperty','window2', 'keyboardCloseKey', 'none' );


	    // setup the chart	    	    
		settings['source'] = new $.jqx.dataAdapter(in_total_data_set);
	    settings['title'] = "In Bound Assets"
	    settings['description'] = "Chart based on grid data above"
	    $('#chart_1').jqxChart(settings);

		settings['source'] = new $.jqx.dataAdapter(out_total_data_set);
	    settings['title'] = "Out Bound Assets"
	    settings['description'] = "Chart based on grid data above"
		$('#chart_2').jqxChart(settings);
		

//	    $('#chart_2').jqxChart(settings);
//	    $('#chart_3').jqxChart(settings);
	}
	$(window).resize(function(){
		$('#chart_1').jqxChart('refresh');
		$('#chart_2').jqxChart('refresh');
	})
	$("#jqxgrid").bind("filter", function (event) {	
		load_chart();
	});
});

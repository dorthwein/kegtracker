// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$( '#_reports_asset_sku_summary_report' ).live('pageshow', function(event){
	// prepare the data
	$.mobile.loading('show');
	var theme = settings.theme

	var source = {
		datatype : "json",
		type: 'GET',
		datafields: [
			{ name: 'date' },																	
			{ name: 'location_network' },
			{ name: 'sku' },
			{ name: 'product' },
			{ name: 'product_entity' },			
			{ name: 'asset_type' },
			{ name: 'empty_quantity' },
			{ name: 'market_quantity' },
			{ name: 'full_quantity' },
			{ name: 'sku_id' },
			{ name: 'date_id' }
		],
		url: system.server + $('.ui-page-active').attr('data-url') + '.json'
	};
	var dataAdapter = new $.jqx.dataAdapter(source);
	// Initialize Grid
	$("#jqxgrid").jqxGrid({		
		groupable: true,
		sortable: true,
		filterable: true,
        showfilterrow: true,		
		autoshowfiltericon: true,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: true,
		height: system.table_height,
		source: dataAdapter,
		columnsresize: true,
		altrows: true,	
		ready: function() {
			load_chart();
		},                			
		columns: [																						
			{ text: 'Date', datafield: 'date', filtertype: 'date', cellsformat: 'd'  },
			{ text: 'Location Network', datafield: 'location_network', filtertype: 'checkedlist' },
			{ text: 'SKU', width:'350px', datafield: 'sku', filtertype: 'checkedlist'  },
			{ text: 'Product', width:'250px', datafield: 'product', filtertype: 'checkedlist'  },
			{ text: 'Brewery',  datafield: 'product_entity', filtertype: 'checkedlist'  },
			{ text: 'Asset Type',  datafield: 'asset_type', filtertype: 'checkedlist' },		
			{ text: 'Empty', width:'75px', datafield: 'empty_quantity', filtertype: 'number' },
			{ text: 'Market', width:'75px', datafield: 'market_quantity', filtertype: 'number' },
			{ text: 'Full', width:'75px', datafield: 'full_quantity', filtertype: 'number' }			

		],
        groups: ['date','location_network']
	});
	

    $('#docking').jqxDocking({ theme: theme,  orientation: 'horizontal', width: '100%', mode: 'docked' });
    $('#docking').jqxDocking('disableWindowResize', 'window1');
    $('#docking').jqxDocking('disableWindowResize', 'window2');
    $('#docking').jqxDocking('disableWindowResize', 'window3');
	$('#docking').jqxDocking('pinWindow', 'window1');
	$('#docking').jqxDocking('pinWindow', 'window2');
	$('#docking').jqxDocking('pinWindow', 'window3');
	$('#docking').jqxDocking('hideAllCloseButtons');
    
	$('#docking').jqxDocking('setWindowProperty','window1', 'keyboardCloseKey', 'none' );
	$('#docking').jqxDocking('setWindowProperty','window2', 'keyboardCloseKey', 'none' );	
	$('#docking').jqxDocking('setWindowProperty','window3', 'keyboardCloseKey', 'none' );	


	// Style Buttons
	$("#excelExport").jqxButton({ theme: theme });
	$("#csvExport").jqxButton({ theme: theme });

	// Button Processing/Action
	
	// NEW BUTTON


	$("#excelExport").click(function () {
//		alert(JSON.stringify($("#jqxgrid").jqxGrid('getrows')));
		$("#jqxgrid").jqxGrid('exportdata', 'xls', 'jqxGrid');           
	});
	$("#csvExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'csv', 'jqxGrid');
	});	
	$.mobile.loading('hide');				

// ***********************
// Charts
// ***********************

	function load_chart(){								
		var rows = $('#jqxgrid').jqxGrid('getrows');			
//		alert(JSON.stringify(rows));
		data_set = {}
		chart_series = [];
		sku_ids = [];
		var unit_interval_max = 1;
		day_limit_counter = 0
		// General Data Set
		$.each(rows, function(key, row){	
//			alert(JSON.stringify(row));		    		
    		if(data_set[row['date_id']] == undefined){
    			data_set[row['date_id']] = {};
    			series = {dataField: row['date_id'], displayText: row['date']}
    			day_limit_counter = day_limit_counter + 1
    		}
    		if(data_set[row['date_id']][row['sku_id']] == undefined){
    			data_set[row['date_id']][row['sku_id']] = {};
				
				if(	$.inArray(row['sku_id'], sku_ids) == -1){	

					series = {dataField: row['sku_id'], displayText: row['sku']}
					sku_ids.push(row['sku_id']);
					chart_series.push(series);
				}
    		}
			data_set[row['date_id']][row['sku_id']]['displayText'] = 	row['sku'];
    		data_set[row['date_id']][row['sku_id']]['full'] = 			row['full_quantity'];
    		data_set[row['date_id']][row['sku_id']]['empty'] = 			row['empty_quantity'];
    		data_set[row['date_id']][row['sku_id']]['market'] = 		row['market_quantity'];    		

    		if((row['full_quantity'] + unit_interval_max) > unit_interval_max){
    			unit_interval_max = unit_interval_max + row['full_quantity']

    		} else if((row['empty_quantity'] + unit_interval_max) > unit_interval_max){    			
				unit_interval_max = unit_interval_max + row['empty_quantity']

    		} else if( (row['market_quantity'] + unit_interval_max) > unit_interval_max){
				unit_interval_max = unit_interval_max + row['market_quantity']
    		}
		}); 
		
		unit_interval = Math.ceil(unit_interval_max / 5)


		// Full Quanitites
		full_asset_data_set = [];
		empty_asset_data_set = [];
		market_asset_data_set = [];
		// Date Record
		$.each(data_set, function(date_id, date_record){
			// Ske Record
			date = new Date(date_id * 1000).toLocaleDateString();
			var full_fact_record = { date: date };
			var empty_fact_record = { date: date };
			var market_fact_record = { date: date };
			
			$.each(date_record, function(sku_id, sku_record){
				full_fact_record[sku_id] = sku_record['full']				
				empty_fact_record[sku_id] = sku_record['empty']				
				market_fact_record[sku_id] = sku_record['market']				
			})
			full_asset_data_set.push(full_fact_record);		
			empty_asset_data_set.push(empty_fact_record);		
			market_asset_data_set.push(market_fact_record);		
		});	
	
    // prepare jqxChart settings
   
	    var settings = {
	        title: " ",
	        description: " ",
	        enableAnimations: true,
	        showLegend: true,
            showBorderLine: false,                
            padding: { left: 5, top: 5, right: 5, bottom: 5 },

	        titlePadding: { left: 90, top: 0, right: 0, bottom: 10 },
	        source: {},
	        categoryAxis:
	            {
					dataField: 'date',											
					textRotationAngle: 90,
					tickMarksColor: '#888888',
	                axisSize: 'auto',
					alignEndPointsWithIntervals: true,				
	        		enableAnimations: true,						
					gridLinesColor: '#888888',

	            },
	        colorScheme: 'scheme01',
	        seriesGroups:
	            [
	                {
	                    type: 'line',
	                    valueAxis:
	                    {	          
 	                       	minValue: 0,
//    	                    maxValue: unit_interval_max,	                    	
//	                    	unitInterval: unit_interval,
	                    	formatSettings: { decimalPlaces:  0 },              
	                        description: '# Assets',
	                        showGridLines: false
	                    },
	                    series: chart_series
	                }	                
	            ]
	    };

	    // setup the chart
	    
	    
		settings['source'] = new $.jqx.dataAdapter(full_asset_data_set);
	    settings['title'] = "Full Assets"
	    settings['description'] = "Chart based on grid data above"
	    $('#chart_1').jqxChart(settings);

		settings['source'] = new $.jqx.dataAdapter(market_asset_data_set);
	    settings['title'] = "Assets in Market"
	    settings['description'] = "Chart based on grid data above"
		$('#chart_2').jqxChart(settings);
		
		settings['source'] = new $.jqx.dataAdapter(empty_asset_data_set);
	    settings['title'] = "Empty Assets"
	    settings['description'] = "Chart based on grid data above"		
		$('#chart_3').jqxChart(settings);

//	    $('#chart_2').jqxChart(settings);
//	    $('#chart_3').jqxChart(settings);
	}
	$(window).resize(function(){
		$('#chart_1').jqxChart('refresh');
		$('#chart_2').jqxChart('refresh');
		$('#chart_3').jqxChart('refresh');

	})
	$("#jqxgrid").bind("filter", function (event) {
		
	
		load_chart();
	});

});

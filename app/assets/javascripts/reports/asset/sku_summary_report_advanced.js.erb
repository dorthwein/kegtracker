// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$(document).on('pageshow', '#_reports_asset_sku_summary_report_advanced', function(event){	
	// prepare the data
	$.mobile.loading('show');
	var theme = settings.theme;
	var source = {
		datatype : "json",
		type: 'POST',
		datafields: [
			{ name: 'fact_time' },																	
			{ name: 'location_network_description' },
			{ name: 'sku_description' },
			{ name: 'product_description' },
			{ name: 'product_entity_description' },			
			{ name: 'asset_type_description' },
			{ name: 'empty_quantity' },
			{ name: 'market_quantity' },
			{ name: 'full_quantity' },
			{ name: 'sku_id' },
			{ name: '_id' }
		],
		url: system.server + $('.ui-page-active').attr('data-url') + '.json',			
		root: 'grid',

	};
	var dataAdapter = new $.jqx.dataAdapter(source, {
		beforeSend: function() {$.mobile.loading('show');},
		loadComplete: function (data) {$.mobile.loading('hide');},

		formatData: function(){
		    var params = {}
		    var filterinfo = $("#jqxgrid").jqxGrid('getfilterinformation');		    		    

		    if(filterinfo != ''){
			    $.each(filterinfo, function(key, filter){
			    	var filter_column = filter['filtercolumn'];		    			    	
			    	var filters = filter['filter'].getfilters();
			    	var values = []
			    	$.each(filters, function(f_key, f_obj){
						x = f_obj.value
						values.push(x);
			    	});		    	
			    	params[filter_column] = values
			    });   
			}
		    return params	    
		},
	}
);
	// Initialize Grid
	$("#jqxgrid").jqxGrid({		
		groupable: true,
		sortable: true,
		filterable: true,
        showfilterrow: true,		
		autoshowfiltericon: true,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: true,
		height: system.table_height,
		source: dataAdapter,
		columnsresize: true,
		altrows: true,	
		ready: function() {

		},                			
		columns: [																						
			{ text: 'Date', datafield: 'fact_time', filtertype: 'date', cellsformat: 'd'  },
			{ text: 'Location Network', datafield: 'location_network_description', filtertype: 'checkedlist' },
			{ text: 'SKU', width:'350px', datafield: 'sku_description', filtertype: 'checkedlist'  },
			{ text: 'Product', width:'250px', datafield: 'product_description', filtertype: 'checkedlist'  },
			{ text: 'Brewery',  datafield: 'product_entity_description', filtertype: 'checkedlist'  },
			{ text: 'Asset Type',  datafield: 'asset_type_description', filtertype: 'checkedlist' },		
			{ text: 'Empty', width:'75px', datafield: 'empty_quantity', filtertype: 'number' },
			{ text: 'Market', width:'75px', datafield: 'market_quantity', filtertype: 'number' },
			{ text: 'Full', width:'75px', datafield: 'full_quantity', filtertype: 'number' }			

		],
        groups: ['fact_time','location_network_description']
	});

// Style Buttons
	$("#excelExport").jqxButton({ theme: theme });
	$("#csvExport").jqxButton({ theme: theme });
	
	$("#advancedView").jqxButton({ theme: theme });
	$("#simpleView").jqxButton({ theme: theme });
	
	// NEW BUTTON


	$("#excelExport").click(function () {
//		alert(JSON.stringify($("#jqxgrid").jqxGrid('getrows')));
		$("#jqxgrid").jqxGrid('exportdata', 'xls', 'jqxGrid');           
	});
	$("#csvExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'csv', 'jqxGrid');
	});	
	$.mobile.loading('hide');				

/*	

    $('#docking').jqxDocking({ theme: theme,  orientation: 'horizontal', width: '100%', mode: 'docked' });
    $('#docking').jqxDocking('disableWindowResize', 'window1');
    $('#docking').jqxDocking('disableWindowResize', 'window2');
    $('#docking').jqxDocking('disableWindowResize', 'window3');
	$('#docking').jqxDocking('pinWindow', 'window1');
	$('#docking').jqxDocking('pinWindow', 'window2');
	$('#docking').jqxDocking('pinWindow', 'window3');
	$('#docking').jqxDocking('hideAllCloseButtons');
    
	$('#docking').jqxDocking('setWindowProperty','window1', 'keyboardCloseKey', 'none' );
	$('#docking').jqxDocking('setWindowProperty','window2', 'keyboardCloseKey', 'none' );	
	$('#docking').jqxDocking('setWindowProperty','window3', 'keyboardCloseKey', 'none' );	
*/
	
/*
// ***********************
// Charts
// ***********************	
	function load_chart(){								
		var grid_rows = $('#jqxgrid').jqxGrid('getrows');							
		var data_set = {}
		var chart_series = [];
		var sku_ids = [];
		var unit_interval_max = 1;
		var day_limit_counter = 0
		// General Data Set
		if(grid_rows != ''){
			$.each(grid_rows, function(key, row){	
	//			alert(JSON.stringify(row));		    		    	
	    		if(data_set[row['fact_time']] == undefined){
	    			data_set[row['fact_time']] = {};
	    			series = {dataField: row['fact_time'], displayText: row['date']}
	    			day_limit_counter = day_limit_counter + 1
	    		}
	    		if(data_set[row['fact_time']][row['sku_id']] == undefined){
	    			data_set[row['fact_time']][row['sku_id']] = {};
					
					if(	$.inArray(row['sku_id'], sku_ids) == -1){	

						series = {dataField: row['sku_id'], displayText: row['sku']}
						sku_ids.push(row['sku_id']);
						chart_series.push(series);
					}
	    		}

				data_set[row['fact_time']][row['sku_id']]['displayText'] = 	row['sku'];
	    		data_set[row['fact_time']][row['sku_id']]['full'] = 			row['full_quantity'];
	    		data_set[row['fact_time']][row['sku_id']]['empty'] = 			row['empty_quantity'];
	    		data_set[row['fact_time']][row['sku_id']]['market'] = 		row['market_quantity'];    		

	    		if((row['full_quantity'] + unit_interval_max) > unit_interval_max){
	    			unit_interval_max = unit_interval_max + row['full_quantity']

	    		} else if((row['empty_quantity'] + unit_interval_max) > unit_interval_max){    			
					unit_interval_max = unit_interval_max + row['empty_quantity']

	    		} else if( (row['market_quantity'] + unit_interval_max) > unit_interval_max){
					unit_interval_max = unit_interval_max + row['market_quantity']
	    		}
			}); 
				
		

			// Full Quanitites
			full_asset_data_set = [];
			empty_asset_data_set = [];
			market_asset_data_set = [];

			// Date Record
			$.each(data_set, function(fact_time, date_record){
				// Ske Record
				date = new Date(fact_time * 1000).toLocaleDateString();
				var full_fact_record = { date: date };
				var empty_fact_record = { date: date };
				var market_fact_record = { date: date };
				
				$.each(date_record, function(sku_id, sku_record){
					full_fact_record[sku_id] = sku_record['full']				
					empty_fact_record[sku_id] = sku_record['empty']				
					market_fact_record[sku_id] = sku_record['market']				
				})

				full_asset_data_set.push(full_fact_record);		
				empty_asset_data_set.push(empty_fact_record);		
				market_asset_data_set.push(market_fact_record);
			});	
		
	    // prepare jqxChart settings
	   
		    var settings = {
		        title: " ",
		        description: " ",
		        enableAnimations: true,
		        showLegend: true,
	            showBorderLine: false,                
	            padding: { left: 5, top: 5, right: 5, bottom: 5 },

		        titlePadding: { left: 90, top: 0, right: 0, bottom: 10 },
		        source: {},
		        categoryAxis:
		            {
						dataField: 'date',											
						textRotationAngle: 90,
						tickMarksColor: '#888888',
		                axisSize: 'auto',
						alignEndPointsWithIntervals: true,				
		        		enableAnimations: true,						
						gridLinesColor: '#888888',

		            },
		        colorScheme: 'scheme01',
		        seriesGroups:
		            [
		                {
		                    type: 'line',
		                    valueAxis:
		                    {	          
	 	                       	minValue: 0,
	//    	                    maxValue: unit_interval_max,	                    	
	//	                    	unitInterval: unit_interval,
		                    	formatSettings: { decimalPlaces:  0 },              
		                        description: '# Assets',
		                        showGridLines: false
		                    },
		                    series: chart_series
		                }	                
		            ]
		    };

		    // setup the chart
		    	    
			settings['source'] = new $.jqx.dataAdapter(full_asset_data_set);
		    settings['title'] = "Full Assets"
		    settings['description'] = "Chart based on grid data above"
		    $('#chart_1').jqxChart(settings);

			settings['source'] = new $.jqx.dataAdapter(market_asset_data_set);
		    settings['title'] = "Assets in Market"
		    settings['description'] = "Chart based on grid data above"
			$('#chart_2').jqxChart(settings);
			
			settings['source'] = new $.jqx.dataAdapter(empty_asset_data_set);
		    settings['title'] = "Empty Assets"
		    settings['description'] = "Chart based on grid data above"		
			$('#chart_3').jqxChart(settings);

	//	    $('#chart_2').jqxChart(settings);
	//	    $('#chart_3').jqxChart(settings);
		} else {
			$('#chart_1').html('');
			$('#chart_2').html('');
			$('#chart_3').html('');
		}
	}
	$(window).resize(function(){
		$('#chart_1').jqxChart('refresh');
		$('#chart_2').jqxChart('refresh');
		$('#chart_3').jqxChart('refresh');

	})
	$("#jqxgrid").bind("filter", function (event) {
		$.mobile.loading('show');
		dataAdapter.dataBind();
		
	});                       
	$("#jqxgrid").bind("bindingcomplete", function (event) {
		$.mobile.loading('hide')			
		load_chart();
	});                       

*/
	
});

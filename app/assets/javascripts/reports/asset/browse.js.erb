// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$( '#_reports_asset_browse' ).live('pageshow', function(event){
	// prepare the data
	$.mobile.loading('show');
	theme = settings.theme;

	// Grid data source
	var grid_source = {
		datatype : "json",
		type: 'GET',
		datafields: [
			{ name: 'entity' },
			{ name: 'brewery'},
			{ name: 'tag_value' },
			{ name: 'asset_type' },
			{ name: 'asset_status' },
			{ name: 'product' },
			{ name: 'location' },
			{ name: 'location_network' },
			{ name: '_id' },
			{ name: 'fill_time' },
			{ name: 'last_action_time' },			
		],
		url: system.server + $('.ui-page-active').attr('data-url') + '.json'
	};
	var grid_data_adapter = new $.jqx.dataAdapter(grid_source, {

		loadComplete: function (data) {},
		loadError: function (xhr, status, error) { }      
	});
		
	// Initiate grid
	$("#jqxgrid").jqxGrid({
		groupable: true,
		sortable: true,
		filterable: true,
		showfilterrow: true,		
        autoshowfiltericon: true,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: true,
		height:  system.table_height,
		source: grid_data_adapter,
		columnsresize: true,
		altrows: true,				
		columns: [
			{ text: 'Owner', datafield: 'entity', filtertype: 'checkedlist' },			
			{ text: 'Product', datafield: 'product', filtertype: 'checkedlist' },			
			{ text: 'Size', datafield: 'asset_type', filtertype: 'checkedlist' },
			{ text: 'Brewery', datafield: 'brewery', filtertype: 'checkedlist' },			
			{ text: 'Fill Date', datafield: 'fill_time', filtertype: 'date', cellsformat: 'd'  },
			{ text: 'Tag Value', datafield: 'tag_value' },
			{ text: 'Status', datafield: 'asset_status', filtertype: 'checkedlist' },			
			{ text: 'Location', datafield: 'location', filtertype: 'checkedlist' },
			{ text: 'Location Network', datafield: 'location_network', filtertype: 'checkedlist' },

			{ text: 'Last Scene', datafield: 'last_action_time', filtertype: 'date', cellsformat: 'd'  },																	
/*
			{ text: 'Options', datafiefld: '_id', sortable: false, filterable: false, columntype: 'button', cellsrenderer: function () {
				return "View";				
			},			
			buttonclick: function (row) {
				$.mobile.loading('show');
				editrow = row;
				var dataRecord = $("#jqxgrid").jqxGrid('getrowdata', editrow);				
				$.ajax({
					url: system.server + $('.ui-page-active').attr('data-url') + '/' + dataRecord._id,
					type: "GET",
					success: function( data ){ 
						var offset = $("#jqxgrid").offset();

						// Initialize Popup Window
						$("#popupWindow").jqxWindow({
							content: data, 
							position: { x: parseInt(offset.left) + 60, y: parseInt(offset.top) + 60}, 
							width: '450px', 
							resizable: true, 
							theme: theme, 
							autoOpen: true,
							cancelButton: $("#Cancel") 
						});
						
						$("#Cancel").jqxButton({ theme: theme });								
						$("#Cancel").click(function () {
							$("#popupWindow").jqxWindow('hide');
						});

						// send edit to server
						$("#popupWindow").jqxWindow('show');																
						$.mobile.loading('hide');	
					},
					error: function (data) {
						alert('Failed to load ' + url);
						$.mobile.loading('hide');
					}
				});
			}
			},	
			*/	
		],
        // groups: ['location_network','asset_state','asset_type','product']		
	});


	$('#jqxgrid').bind('rowselect', function (event){	    
		$.mobile.loading('show');		
	    var args = event.args;
	    var row = args.rowindex;
	    var rowdata = $('#jqxgrid').jqxGrid('getrowdata', row);		
		$.ajax({
			url: system.server + $('.ui-page-active').attr('data-url') + '/row_select',
			type: "POST",
			data: rowdata,
			success: function( data ){ 			
				$('#asset_transactions').html('<div style="text-align:center;"> <h1> Please Select a Life Cycle <h1> </div>');	

				$("#jqxListBox").jqxListBox({ source: data, width: '100%', height: '100%', theme: theme });
				$("#jqxListBox").jqxListBox('selectIndex', 0 ); 
				// Load the data from the Select html element.
				$.mobile.loading('hide');		

			}
		});
	});
	$("#jqxListBox").bind('select', function (event) {	
		$.mobile.loading('hide');		
        var args = event.args;	        
        var item = args.item;
		$.ajax({
			url: system.server + $('.ui-page-active').attr('data-url') + '/life_cycle_select',
			type: "POST",
			data: {fill_asset_activity_fact_id: item.value},
			success: function( data ){ 				
				$.mobile.loading('hide');			
				$('#asset_transactions').html(data.html);
			},
			error: function(data){
				$.mobile.loading('hide');		
				alert('Error:' + JSON.stringify(data));
			}
		});	        
	});			
    $(window).resize(function() {
//		$('#docking').jqxDocking('refresh');   		
			
//    	$('#jqxgrid').jqxGrid('refresh');
    })

    $('#docking').jqxDocking({ theme: theme,  orientation: 'horizontal', width: '100%', mode: 'docked' });
    $('#docking').jqxDocking('disableWindowResize', 'window1');
    $('#docking').jqxDocking('disableWindowResize', 'window2');
	$('#docking').jqxDocking('pinWindow', 'window1');
	$('#docking').jqxDocking('pinWindow', 'window2');
	$('#docking').jqxDocking('hideAllCloseButtons');
    
	$('#docking').jqxDocking('setWindowProperty','window1', 'keyboardCloseKey', 'none' );
	$('#docking').jqxDocking('setWindowProperty','window1', 'keyboardCloseKey', 'none' );	

	// Create a jqxListBox
	$("#excelExport").jqxButton({ theme: theme });
	$("#csvExport").jqxButton({ theme: theme });
	$("#jsonExport").jqxButton({ theme: theme });


	$("#excelExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'xls', 'jqxGrid');           
	});

	$("#csvExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'csv', 'jqxGrid');
	});

	$("#jsonExport").click(function () {
		alert($("#jqxgrid").jqxGrid('exportdata', 'json' ))
	});

	$.mobile.loading('hide');		

});

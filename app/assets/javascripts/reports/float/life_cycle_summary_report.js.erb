// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$(document).on('pageshow', '#_reports_float_life_cycle_summary_report', function(event){	
	// prepare the data
	$.mobile.loading('show');
	var theme = settings.theme

	var source =
	{
		datatype : "json",
		type: 'GET',
		datafields: [

			{ name: 'date' },				

													
			{ name: 'location_network' },
			{ name: 'asset_type' },
			{ name: 'asset_state' },			
			{ name: 'product' },
			{ name: 'handle_code' },

			{ name: 'quantity' },
			
		],
		url: system.server + $('.ui-page-active').attr('data-url') + '.json'
	};

	var dataAdapter = new $.jqx.dataAdapter(source, {
		loadComplete: function (data) { },
		loadError: function (xhr, status, error) { }      
	});
	// Initialize Grid
	$("#jqxgrid").jqxGrid(
	{
		groupable: true,
		sortable: true,
		filterable: true,
        showfilterrow: true,
		autoshowfiltericon: true,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: true,
		height: system.table_height,

		source: dataAdapter,
		columnsresize: true,
		altrows: true,				
		ready: function () {

		},                			
		columns: [
																					
			{ text: 'Date', datafield: 'date' },				
													
			{ text: 'Location Network', datafield: 'location_network' },
			{ text: 'Asset Type', datafield: 'asset_type' },
//			{ text: 'Asset State', datafield: 'asset_state' },			
			{ text: 'Product', datafield: 'product' },
			{ text: 'Action', datafield: 'handle_code' },			

			{ text: 'Quantity', datafield: 'quantity' }, 	            	
		],
        groups: ['date','location_network','asset_type','handle_code']
		
	});
	var listSource = [
			{ label: 'Date', value: 'date', checked: true },
			{ label: 'Network', value: 'network', checked: true },
			{ label: 'Asset Type', value: 'asset_type', checked: true }, 
			{ label: 'Product', value: 'product', checked: true },
			
//			{ label: 'Asset State', value: 'asset_state', checked: true },
			{ label: 'Action', value: 'handle_code', checked: true },
			{ label: 'Quantity', value: 'quantity', checked: true },
			
	];
	$("#jqxlistbox").jqxListBox({ source: listSource, width: '100%', height: 300, theme: theme, checkboxes: true });
	$("#jqxlistbox").bind('checkChange', function (event) {
		if (event.args.checked) {
			$("#jqxgrid").jqxGrid('showcolumn', event.args.value);
		}
		else {
			$("#jqxgrid").jqxGrid('hidecolumn', event.args.value);
		}
	});
	// Style Buttons
	$("#addrowbutton").jqxButton({ theme: theme });            
	$("#excelExport").jqxButton({ theme: theme });
	$("#csvExport").jqxButton({ theme: theme });

	// Button Processing/Action
	
	// NEW BUTTON
	$("#addrowbutton").click(function () {
		$.mobile.loading('show');
		url = system.server + $('.ui-page-active').attr('data-url') + '/new'
		$.ajax({
			url: url,
			type: "GET",
			success: function( data ){ 
				var offset = $("#jqxgrid").offset();

				$("#popupWindow").jqxWindow({
					content: data, 
					position: { x: parseInt(offset.left) + 60, y: parseInt(offset.top) + 60}, 
					width: 650, 
					resizable: true, 
					theme: theme, 
					autoOpen: true, 
					cancelButton: $("#Cancel") 
				});

			// open the popup window when the user clicks a button.						
				$("#popupWindow").jqxWindow('show');												
				// initialize the popup window and buttons.
				$("#Cancel").jqxButton({ theme: theme });
				$("#Cancel").click(function () {
					$("#popupWindow").jqxWindow('hide');
				});

				$("#Save").jqxButton({ theme: theme });
				// update the edited row when the user clicks the 'Save' button.

				$("#Save").click(function () {
					// send edit to server
					var values = {};
					$.each($(this).closest('form').serializeArray(), function(i, field) {
						values[field.name] = field.value;
					});

					$.ajax({
						url: $(this).closest('form').attr('action'),
						type: "POST",
						data: values,										
						dataType: 'json',
						success: function( data ){ 
							$("#jqxgrid").jqxGrid('addrow', null, data);
							$("#popupWindow").jqxWindow('hide');												
						},
						error: function (data) {
							alert('fail')
							$("#popupWindow").jqxWindow('hide');																							
						}
					});

				});
				
				$.mobile.loading('hide');								
			},
			error: function (data) {
				alert('Failed to load ' + url);
				$.mobile.loading('hide');									
			}
		});
	
	});

	$("#excelExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'xls', 'jqxGrid');           
	});
	$("#csvExport").click(function () {
		$("#jqxgrid").jqxGrid('exportdata', 'csv', 'jqxGrid');
	});
	$.mobile.loading('hide');				

});

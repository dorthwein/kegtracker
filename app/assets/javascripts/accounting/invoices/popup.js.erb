// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.
// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$(document).on('pageshow', '#accounting_invoices_popup', function() {
	$.mobile.loading('show');
	var theme = settings.theme
	var url =  system.server + $('.ui-page-active').attr('data-url');
	url = url.substring(0, url.length - 4) + 'invoice_line_items';

//	url = system.server + $('.ui-page-active').attr('data-url') + '.json'
	var source = {
		datatype: "json",
		type: "GET",
		datafields: [
			{name: 'sku_description', type: 'string'},
			{name: 'quantity', type: 'number'},	
			{name: 'invoice_attached_asset_count', type: 'number'},				
			{name: '_id'},	
		], 
		url: url,		
	};

	window.dataAdapter = new $.jqx.dataAdapter(source, {
		beforeSend: function(jqXHR, settings){
			$.mobile.loading('show');	
		},
		loadComplete: function (data) {			
			$.mobile.loading('hide');
		},
		loadError: function (xhr, status, error) { }

	});
	//	window.dataAdapter = dataAdapter
	// 	Initialize Grid

	$(".jqxGrid").jqxGrid({
		// Grid Options
		groupable: false,
		sortable: true,       
		filterable: false,
		showfilterrow: false,		
        autoshowfiltericon: false,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: false,
		height:  200,
		source: dataAdapter,	
		columnsresize: true,
		altrows: true,		
		columns: [
			{text: 'SKU',  datafield: 'sku_description'},
			{text: 'Fullfilled',  datafield: 'invoice_attached_asset_count', width:100},
			{text: 'Qty',  datafield: 'quantity', width:100},
		]
	});
	$.mobile.loading('hide');
});

$(document).on('pageshow', '#accounting_invoices_popup.popup_edit', function() {
	var theme = settings.theme
	$('#number').jqxInput({disabled: true})
	$('#quantity').jqxInput({width:50, height:20, rtl: false, theme: theme})		
	
	$('#add_invoice_line_item').click(function () {
		$.mobile.loading('show');		
        var params = {record: {}}
		
		params['record']['sku_id'] = $('#sku_id').jqxDropDownList('getSelectedItem').value
		params['record']['quantity'] = $('#quantity').val()

		var url =  system.server + $('.ui-page-active').attr('data-url');
		url = url.substring(0, url.length - 4) + 'invoice_line_items';

		$.ajax({
			type: "POST",
			dataType : "JSON",
			url: url,
			data: params,
		}).done(function( data ) {						
			window.dataAdapter.dataBind();
		})
		$.mobile.loading('hide');
	});

	$("#delete_invoice_line_item").click(function () {
		var rowindex = $('.jqxGrid').jqxGrid('getselectedrowindex');
		var rowdata = $('.jqxGrid').jqxGrid('getrowdata', rowindex);		
		var url =  system.server + $('.ui-page-active').attr('data-url');
		url = url.substring(0, url.length - 4) + 'invoice_line_items/' + rowdata['_id'];		
		$.ajax({
			type: "DELETE",
			dataType : "JSON",
			url: url, // system.server + $('.ui-page-active').attr('data-url') + '/' + rowdata['_id'],
		}).done(function( data ) {
			window.dataAdapter.dataBind();
		});		        	
	});
	$(".save").click(function () {
		$('#add_to_invoice').empty()
	})
})			

$(document).on('pageshow', '#accounting_invoices_popup.popup_new', function() {	
	$('#add_to_invoice').empty()

	$('#number').on('change', function () { 
		$.mobile.loading('show');		
		var url =  system.server + $('.ui-page-active').attr('data-url')
		url = url.replace('/new', '');

        var params = {record: {}}
		$.each($('.jqxDropDownList'), function(key, value){
			element = $('#' + value.id)				
			params['record'][value.id] = $(element).jqxDropDownList('getSelectedItem').value              				
		})

		$.each($('.jqxInput'), function(key, value){
			element = $('#' + value.id)
			params['record'][value.id] = $(element).val();
		})

		$.each($('.jqxNumberInput'), function(key, value){
			element = $('#' + value.id)
			params['record'][value.id] = $(element).jqxNumberInput('getDecimal');
		})

		$.each($('.jqxDateTimeInput'), function(key, value){		
			element = $('#' + value.id)
			params['record'][value.id] = $(element).jqxDateTimeInput('getDate'); 
		});

		$.each($('.jqxToggle'), function(key, value){
			element = $('#' + value.id)
			params['record'][value.id] = $(element).val();
		})
		
		$.ajax({
			url: url,
			type: "POST",
			dataType : "JSON",
			data: params,
		}).done(function( data ) {			
			window.parent.dataAdapter.dataBind();					
//			window.parent.$('.jqxWindow').jqxWindow('close');
	//		window.opener.dataAdapter.dataBind();				
			document.location.href = url + '/' + data['_id'] + '/edit';
			$.mobile.loading('hide');
		})
	});
});


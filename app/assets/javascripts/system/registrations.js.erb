// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.
// # Place all the behaviors and hooks related to the matching controller here.
// # All this logic will automatically be available in application.js.

$(document).on('pageshow', '#_system_registrations', function(event){	
	// prepare the data
	$.mobile.loading('show');
	var theme = settings.theme

	url = system.server + $('.ui-page-active').attr('data-url') + '.json'	
	var source =
	{
		datatype: "json",
		datafields: [
			{name: 'brewery_name'},	
			{name: 'contact_name'},	
			{name: 'contact_email'},	
			{name: 'contact_phone'},	
			{name: 'street'},	
			{name: 'city'},	
			{name: 'state'},	
			{name: 'zip'},	
			{name: 'rfid_interest'},	
			{name: 'distributor_count'},	
			{name: 'notes'},	
			{name: 'asset_count'},	
		], 
		url: url,
		updaterow: function (rowid, rowdata, commit) {
			// synchronize with the server - send update command
			// call commit with parameter true if the synchronization with the server is successful 
			// and with parameter false if the synchronization failder.		
			commit(true);
		}
		
	};

	var dataAdapter = new $.jqx.dataAdapter(source, {
		beforeSend: function(jqXHR, settings){
			$.mobile.loading('show');	
		},
		loadComplete: function (data) { 
			$.mobile.loading('hide');
		},
		loadError: function (xhr, status, error) { }      
	});

	// Initialize Grid
	$("#jqxgrid").jqxGrid(
	{
		// Grid Options
		groupable: true,
		sortable: true,
		filterable: true,
		showfilterrow: true,		
        autoshowfiltericon: true,		
		theme: theme,
		width: '100%',
		groupsexpandedbydefault: true,
		height:  system.table_height,
		source: dataAdapter,
		columnsresize: true,
		altrows: true,		
		columns: [
			{text:'Brewey', datafield: 'brewery_name'},	
			{text:'Name', datafield: 'contact_name'},	
			{text:'Email', datafield: 'contact_email'},	
			{text:'Phone', datafield: 'contact_phone'},	
			{text:'Street', datafield: 'street'},	
			{text:'City', datafield: 'city'},	
			{text:'State', datafield: 'state'},	
			{text:'Zip', datafield: 'zip'},	
			{text:'RFID (Y/N)', datafield: 'rfid_interest'},	
			{text:'# Dist.', datafield: 'distributor_count'},	
			{text:'# Asset', datafield: 'asset_count'},			
			{text:'Notes', datafield: 'notes'},	
		]
	});
	$('#jqxgrid').bind('rowselect', function (event){	    
	    var args = event.args;
	    var row = args.rowindex;
	    var rowdata = $('#jqxgrid').jqxGrid('getrowdata', row);		
		$.ajax({
			url: system.server + $('.ui-page-active').attr('data-url') + '/' + rowdata['_id'],
			type: "GET",
			dataType : "JSON",
			data: rowdata,
		}).done(function( data ) {				
			// Entity List
			$("#admin_user_id").jqxDropDownList({ source: data['users'], disabled: false });			
			var item = $("#admin_user_id").jqxDropDownList('getItemByValue', data['entity']['admin_user_id']);
			$("#admin_user_id").jqxDropDownList('selectItem', item ); 			

			$(".form_input").jqxInput({disabled: false });
			$(".form_input").val('');
			$(".toggle_switch").jqxToggleButton({disabled: false });
			
			$("#updateSaveButton").jqxButton({disabled: false});
			$("#updateSaveButton").show();
			$("#newSaveButton").hide();
			$("#newCancelButton").hide();

//			alert(JSON.stringify(data['user']));
			// User Detail Input Values

			$.each(data['entity'], function(key, value){
				element = $('#' + key)
				if( element.hasClass('toggle_switch')){
//			        var toggled = $(this).jqxToggleButton('toggled');					
			        if (value == 1) {			        	
			            element.html('On');
//			            element.val(1);
			            element.jqxToggleButton({ toggled: true });
			            element.jqxToggleButton('refresh');
			        }
			        else {
						element.html('Off');
//			            element.val(0);
			            element.jqxToggleButton({toggled: false });
			            element.jqxToggleButton('refresh');
			        }			    				
				}
				element.val(value)				
			})
		});					
	});

    $('#docking').jqxDocking({ theme: theme,  orientation: 'horizontal', width: '100%', mode: 'docked' });
    $('#docking').jqxDocking('disableWindowResize', 'window1');
    $('#docking').jqxDocking('disableWindowResize', 'window2');
	$('#docking').jqxDocking('pinWindow', 'window1');
	$('#docking').jqxDocking('pinWindow', 'window2');
	$('#docking').jqxDocking('hideAllCloseButtons');
	
	$('#docking').jqxDocking('setWindowProperty','window1', 'keyboardCloseKey', 'none' ),

	$.mobile.loading('hide');					

});
